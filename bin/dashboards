#!/usr/bin/env bash
GRAFANA_HOST=$(docker inspect -f "{{ .NetworkSettings.Networks.setup_default.IPAddress }}" dashboard)
ELASTIC_HOST=$(docker inspect -f "{{ .NetworkSettings.Networks.setup_default.IPAddress }}" elastic)

generate_post_data()
{
  cat <<EOF
{
    "id": 1,
    "name": "ARD_AVAILABLE",
    "type": "elasticsearch",
    "access": "proxy",
    "url": "http://${ELASTIC_HOST}:9200",
    "password": "",
    "user": "",
    "database": "ard-tiles",
    "jsonData": {
        "timeField": "modified_date",
        "esVersion":56
    },
    "basicAuth": false,
    "isDefault": true,
    "readOnly": false
}
EOF
}
curl -X POST -u admin:secret -H "Content-Type: application/json" \
      http://${GRAFANA_HOST}:3000/api/datasources -d "$(generate_post_data)"
echo; echo;

generate_post_data()
{
  cat <<EOF
{
    "id": 2,
    "name": "LAYERS_INGESTED",
    "type": "elasticsearch",
    "access": "proxy",
    "url": "http://${ELASTIC_HOST}:9200",
    "password": "",
    "user": "",
    "database": "iwds-tifs",
    "basicAuth": false,
    "isDefault": false,
    "jsonData": {
      "timeField": "http_date",
      "esVersion":56
    },
    "readOnly": false
  }
EOF
}
curl -X POST -u admin:secret -H "Content-Type: application/json" \
      http://${GRAFANA_HOST}:3000/api/datasources -d "$(generate_post_data)"
echo; echo;

generate_post_data()
{
  cat <<EOF
{
    "id": 2,
    "name": "MISSING_TIFS",
    "type": "elasticsearch",
    "access": "proxy",
    "url": "http://${ELASTIC_HOST}:9200",
    "password": "",
    "user": "",
    "database": "iwds-tifs",
    "basicAuth": false,
    "isDefault": false,
    "jsonData": {
      "timeField": "@timestamp",
      "esVersion":56
    },
    "readOnly": false
  }
EOF
}
curl -X POST -u admin:secret -H "Content-Type: application/json" \
      http://${GRAFANA_HOST}:3000/api/datasources -d "$(generate_post_data)"
echo; echo;


curl -X POST -u admin:secret  -H "Content-Type: application/json" \
      http://${GRAFANA_HOST}:3000/api/dashboards/db -d @bin/overview.json
echo; echo;


curl -X POST -u admin:secret -H "Content-Type: application/json" \
       http://${GRAFANA_HOST}:3000/api/admin/users \
       -d ' { "name":"User", "email":"", "login":"user", "password":"userpassword"}'


curl -X PUT -u user:userpassword -H "Content-Type: application/json" \
      http://${GRAFANA_HOST}:3000/api/user/preferences \
      -d '{"theme":"dark","homeDashboardId":1,"timezone":"browser"}'
echo; echo;
